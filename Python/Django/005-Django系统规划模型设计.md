[TOC]

# Django的系统设计

## 根据需求设计用例图



## 根据用例图设计类图

每个实体类就是一个模型（mode），需要考虑每个类之间的关系。

![img](Django%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1.assets/basic-class-diagram.png)

将类之间的关系，和每个类内部的属性方法确定后，可以得到较为丰富的类图。

![models](Django%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1.assets/class-diagram.png)

## 线框图



# 系统设计部分总结

深入学习可以参考设计模式，书籍推荐如下：
《大话设计模式》
《Head first 设计模式》
《设计模式》GOF

# 模型设计

模型mode其实就代表了数据库的`表`，而模型的编程表现就是“类（class）”

需要在boards/modes.py中添加如下代码：

```python
from django.db import models
from django.contrib.auth.models import User
# Create your models here.
#新版EP8表明python的两个Class或者function之间需要空两行

class Board(models.Model): //会在数据库中创建一个Board的表
    name = models.CharField(max_length=30,unique=True) # 设定name这个列是数据表Board中的唯一项，不能重复值
    description = models.CharField(max_length=100)


class Topic(models.Model):
    subject = models.CharField(max_length=255,)
    last_updated = models.DateTimeField(auto_now_add=True)
    board = models.ForeignKey(Board, related_name='topics', on_delete=models.CASCADE)
# 在Djnago2.x之后，外键中on_delete是必须选项，这其实是SQL中的标准，
# 即删除Board的实例之后，也需要用是删除他refer的Topic
# 这是Stackoverflow的详细解释
# https://stackoverflow.com/questions/38388423/what-does-on-delete-do-on-django-models
    starter = models.ForeignKey(User, related_name='topics', on_delete=models.CASCADE)


class Post(models.Model):
    message = models.TextField(max_length=4000)
    topic = models.ForeignKey(Topic, related_name='posts', on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(null=True)
    created_by = models.ForeignKey(User, related_name='posts', on_delete=models.CASCADE)
    updated_by = models.ForeignKey(User, null=True, related_name='+', on_delete=models.CASCADE)
```

可以看出来mode中设定的每个类都是django.db.models.Model 的子类。

每个模型类最终会转换为数据库`表`。



## 创建模型的迁移文件

接下来需要告诉Django创建数据库表,通过如下命令，创建`模型类`的`迁移文件midrations`
然后需要依据这个迁移文件创建数据库的表和列

```shell
python manage.py makemigrations
```
output:
```shell
Migrations for 'boards':
  boards/migrations/0001_initial.py
    - Create model Board
    - Create model Topic
    - Create model Post
```
可以看到在应用Board的目录下多了一个迁移文件0001_initial.py：

```shell
(Djangoenv)  ~/Documents/OneDrive/Code项目/PythonProject/ProjetTestVirtualENV$master$ tree -L 3 --matchdirs Project1
```
Output:
```shell
Project1
├── Project1
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-39.pyc
│   │   ├── settings.cpython-39.pyc
│   │   ├── urls.cpython-39.pyc
│   │   └── wsgi.cpython-39.pyc
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── boards
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-39.pyc
│   │   ├── admin.cpython-39.pyc
│   │   ├── apps.cpython-39.pyc
│   │   ├── models.cpython-39.pyc
│   │   └── views.cpython-39.pyc
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   │   ├── 0001_initial.py // 新增的迁移文件
│   │   ├── __init__.py
│   │   └── __pycache__
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── db.sqlite3
└── manage.py
```
迁移文件会被翻译成SQL，迁移文件的内容如下：
```python
# Generated by Django 3.2.2 on 2021-05-22 07:59

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Board',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=30, unique=True)),
                ('description', models.CharField(max_length=100)),
            ],
        ),
        migrations.CreateModel(
            name='Topic',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('subject', models.CharField(max_length=255)),
                ('last_updated', models.DateTimeField(auto_now_add=True)),
                ('board', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='topics', to='boards.board')),
                ('starter', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='topics', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='Post',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('message', models.TextField(max_length=4000)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(null=True)),
                ('created_by', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='posts', to=settings.AUTH_USER_MODEL)),
                ('topic', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='posts', to='boards.topic')),
                ('updated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
        ),
    ]
```

输入如下命令可以查看由迁移文件转换的SQL语句
```shell
python manage.py sqlmigrate boards 0001
```
Output:
```shell
BEGIN;
--
-- Create model Board
--
CREATE TABLE "boards_board" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "name" varchar(30) NOT NULL UNIQUE, "description" varchar(100) NOT NULL);
--
-- Create model Topic
--
CREATE TABLE "boards_topic" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "subject" varchar(255) NOT NULL, "last_updated" datetime NOT NULL, "board_id" bigint NOT NULL REFERENCES "boards_board" ("id") DEFERRABLE INITIALLY DEFERRED, "starter_id" integer NOT NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED);
--
-- Create model Post
--
CREATE TABLE "boards_post" ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "message" text NOT NULL, "created_at" datetime NOT NULL, "updated_at" datetime NULL, "created_by_id" integer NOT NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED, "topic_id" bigint NOT NULL REFERENCES "boards_topic" ("id") DEFERRABLE INITIALLY DEFERRED, "updated_by_id" integer NULL REFERENCES "auth_user" ("id") DEFERRABLE INITIALLY DEFERRED);
CREATE INDEX "boards_topic_board_id_4462fe82" ON "boards_topic" ("board_id");
CREATE INDEX "boards_topic_starter_id_60e98681" ON "boards_topic" ("starter_id");
CREATE INDEX "boards_post_created_by_id_0b841038" ON "boards_post" ("created_by_id");
CREATE INDEX "boards_post_topic_id_f477c024" ON "boards_post" ("topic_id");
CREATE INDEX "boards_post_updated_by_id_76d3c48f" ON "boards_post" ("updated_by_id");
COMMIT;
```

## 用迁移文件创建数据库

输入如下命令，在数据库创建表和列
```shell
python manage.py migrate
```
Output:
```shell
Operations to perform:
  Apply all migrations: admin, auth, boards, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying boards.0001_initial... OK // 这是我们创建的迁移文件成功创建数据库的log
  Applying sessions.0001_initial... OK
```
由于是第一次进行数据库迁移，所以将所有所有应用（内置应用）的迁移文件都会执行一边，这些内置应用是配置在`INSTALLED_APPS`中。

## 测试模型类

可以使用manage.py 直接测试创建的mode类
与普通直接输入python，进入解释器不同，通过`python manage.py shell`进入命令行，项目将被添加到`sys.path`并加载Django。这意味着我们可以在项目中导入我们的模型和其他资源并使用它。

输入如下命令：
```shell
python manage.py shell
```

![image-20210522215732378](https://tva1.sinaimg.cn/large/008i3skNgy1gqrjtwelysj31tg07s405.jpg)

在命令行引用创建的模型类：
```python
Python 3.9.5 (default, May  4 2021, 03:33:11)
[Clang 12.0.0 (clang-1200.0.32.29)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
>>> from boards.models import Board
>>> board = Board(name='Django', description='This is a board about Django.') #创建模型类的对象
>>> board.save() # 保存对象到数据库中
>>> board.id
1
>>> board.name
'Django'
>>> board.description
'This is a board about Django.'
```
每个Django的`模型类`都具有一个默认属性`objects`，即Model Manager，猪羊用于数据库的操作：

```shell
python manage.py shell
>>> board = Board.objects.create(name='Python', description='General discussion about Python.') # 在数据库中创建模型的实例、对象的
>>> Board.objects.all() # 查看所有的Board的对象
<QuerySet [<Board: Board object (1)>, <Board: Board object (2)>]>
>>> exit()
```

添加对象的字符串表现函数：

```python
class Board(models.Model):
    name = models.CharField(max_length=30, unique=True,)
    description = models.CharField(max_length=100)

    def __str__(self):
        return self.name
```




```python
(Djangoenv)  ~/Documents/OneDrive/Code项目/PythonProject/ProjetTestVirtualENV/Project1   master  python manage.py shell
Python 3.9.5 (default, May  4 2021, 03:33:11)
[Clang 12.0.0 (clang-1200.0.32.29)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
>>> from boards.models import Board
>>> Board.objects.all()
<QuerySet [<Board: Django>, <Board: Python>]>
>>>
```
```python
mode.objects.create
```

等价于
```python
'insatance = mode()'+'instance.save()''两条命令
```

### 总结Objects属性的操作


| 操作                               | 代码示例                                        |
| :--------------------------------- | :---------------------------------------------- |
| 创建一个对象而不保存               | board = Board()                                 |
| 保存一个对象到数据库（创建或更新） | board.save()                                    |
| 数据库中创建并保存一个对象         | Board.objects.create(name=’…’, description=’…’) |
| 列出数据库中所有对象               | Board.objects.all()                             |
| 通过字段标识获取单个对象           | Board.objects.get(id=1)                         |

# 参考文档和链接

[1]: https://stackoverflow.com/questions/38388423/what-does-on-delete-do-on-django-models
